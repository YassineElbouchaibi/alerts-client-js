<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>

    <title>Barchart Alert Client API</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">
    <link rel="stylesheet" href="example.css" type="text/css">

    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.4.0/knockout-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.0.0/lodash.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
    <script src="../../dist/barchart-alerts-api.js"></script>

    <script type="text/javascript">
        'use strict';

        var system = 'barchart.com';
        var userId = 'barchart-test-user';

        //var alertManager = new Barchart.Alerts.RestAlertManager();

        var alertManager = new Barchart.Alerts.RestAlertManager('alerts-management-stage.barchart.com');
        //var alertManager = new Barchart.Alerts.RestAlertManager('localhost', 3000);
        //var alertManager = new Barchart.Alerts.SocketIOAlertManager('alerts-management-stage.barchart.com');
        //var alertManager = new Barchart.Alerts.SocketIOAlertManager('localhost', 3000);

        var utilities = Barchart.Alerts.AlertManager;

        var targets = ko.observable();
        var properties = ko.observable();
        var operators = ko.observable();
        var publisherTypes = ko.observable();

        function PageModel() {
            var that = this;

            that.version = ko.observable();

            that.alert = ko.observable();
            that.alerts = ko.observableArray([ ]);
            that.activeTemplate = ko.observable('alert-grid-template');
            that.providerDescription = ko.observable(alertManager.toString());

            var getModel = function(alert) {
                return _.find(that.alerts(), function(model) {
                    return model.alert().alert_id === alert.alert_id;
                });
            };
            var sortModels = function() {
                that.alerts.sort(function(a, b) {
                    return a.alert().name.localeCompare(b.alert().name);
                });
            };

            that.changeToGrid = function() {
                that.alerts([ ]);

                that.activeTemplate('alert-grid-template');

                alertManager.retrieveAlerts({ user_id: userId, alert_system: system })
                    .then(function(alerts) {
                        that.alerts([ ]);

                        _.forEach(alerts, function(alert) {
                            that.alerts.push(new AlertDisplayModel(alert));
                        });

                        sortModels();
                    });
            };
            that.changeToCreate = function() {
                that.alert = new AlertEntryModel();

                that.activeTemplate('alert-entry-template');
            };
            that.changeToView = function(alertEntryModel) {
                that.alert = new AlertEntryModel(alertEntryModel.alert());

                that.activeTemplate('alert-entry-template');
            };
            that.deleteAlert = function(alertDisplayModel) {
                alertDisplayModel.processing(true);

                alertManager.deleteAlert(alertDisplayModel.alert())
                    .then(function() {
                        that.alerts.remove(alertDisplayModel);
                    });
            };

            that.handleAlertChange = function(changedAlert) {
                var existingModel = getModel(changedAlert);

                if (existingModel) {
                    existingModel.alert(changedAlert);
                } else {
                    that.alerts.push(new AlertDisplayModel(changedAlert));

                    sortModels();
                }
            };
            that.handleAlertDelete = function(deletedAlert) {
                var modelToRemove = getModel(deletedAlert);

                that.alerts.remove(modelToRemove);
            };

            that.changeToGrid();
        }
        function AlertDisplayModel(alert) {
            var that = this;

            that.alert = ko.observable(alert);
            that.processing = ko.observable(false);

            that.lastTriggerDateDisplay = ko.computed(function() {
                var alert = that.alert();

                var returnRef;

                if (alert.last_trigger_date) {
                    var lastTriggerDate = new Date(parseInt(alert.last_trigger_date));

                    returnRef = lastTriggerDate.toString();
                } else {
                    returnRef = 'never';
                }

                return returnRef;
            });

            that.canStart = ko.computed(function() {
                var alert = that.alert();

                return alert.alert_state === 'Inactive' || alert.alert_state === 'Triggered';
            });
            that.canPause = ko.computed(function() {
                var alert = that.alert();

                return alert.alert_state === 'Active';
            });
            that.canRefresh = ko.computed(function() {
                return !that.canStart() && !that.canPause();
            });

            that.start = function() {
                alertManager.enableAlert(that.alert())
                    .then(function(updatedAlert) {
                        that.alert(updatedAlert);
                    });
            };
            that.pause = function() {
                alertManager.disableAlert(that.alert())
                    .then(function(updatedAlert) {
                        that.alert(updatedAlert);
                    });
            };
            that.refresh = function() {
                alertManager.retrieveAlert(that.alert())
                    .then(function(refreshedAlert) {
                        that.alert(refreshedAlert);
                    });
            };
        }
        function AlertEntryModel(alert) {
            var that = this;

            that.alert = ko.observable(alert || null);
            that.name = ko.observable(null);
            that.automaticReset = ko.observable(false);
            that.createDate = ko.observable(null);
            that.conditions = ko.observableArray([]);
            that.publishers = ko.observableArray([]);
            that.processing = ko.observable(false);
            that.complete = ko.observable(false);

            that.clearAlert = function() {
                that.alert(null);
                that.name(null);
                that.automaticReset(false);
                that.createDate(null);
                that.conditions([]);
                that.publishers([]);
            };
            that.createAlert = function() {
                that.processing(true);

                var alert = {
                    name: that.name(),
                    user_id: userId,
                    alert_system: system,
                    automatic_reset: that.automaticReset(),
                    conditions: _.map(that.conditions(), function(condition) {
                        var conditionData = {
                            property: {
                                property_id: condition.property().property_id,
                                target: {
                                    identifier: condition.targetIdentifier()
                                }
                            },
                            operator: {
                                operator_id: condition.operator().operator_id,
                                operand: condition.operand()
                            }
                        };

                        var qualifiers = condition.qualifiers();

                        if (qualifiers.length > 0) {
                            conditionData.property.target.qualifiers = _.map(qualifiers, function(qualifier) {
                                 return qualifier.qualifierValue();
                            });
                        }

                        return conditionData;
                    }),
                    publishers: _.map(that.publishers(), function(publisher) {
                        return {
                            type: {
                                publisher_type_id: publisher.publisherType().publisher_type_id
                            },
                            recipient: publisher.recipient(),
                            format: publisher.format()
                        };
                    })
                };

                alertManager.createAlert(alert)
                    .then(function(created) {
                        that.alert(created);
                    })
                    .finally(function() {
                        that.processing(false);
                    });
            };

            that.addCondition = function(conditionToAdd) {
                that.conditions.push(new AlertConditionModel(that.ready, conditionToAdd || null));
            };
            that.removeCondition = function(conditionToRemove) {
                that.conditions.remove(conditionToRemove);
            };
            that.addPublisher = function(publisherToAdd) {
                that.publishers.push(new AlertPublisherModel(that.ready, publisherToAdd || null));
            };
            that.removePublisher = function(publisherToRemove) {
                that.publishers.remove(publisherToRemove);
            };

            that.complete = ko.computed(function() {
                return _.isObject(that.alert());
            });
            that.ready = ko.computed(function() {
                return !that.complete() && !that.processing();
            });
            that.canSave = ko.computed(function() {
                return that.ready() && _.isString(that.name()) && that.name().length > 0;
            });

            if (_.isObject(alert)) {
                that.name(alert.name);

                that.automaticReset(_.isBoolean(alert.automatic_reset) && alert.automatic_reset);
                that.createDate(new Date(parseInt(alert.create_date)));

                _.forEach(alert.conditions, function(condition) {
                    that.addCondition(condition);
                });
                _.forEach(alert.publishers, function(publisher) {
                    that.addPublisher(publisher);
                });
            }
        }
        function AlertConditionModel(ready, condition) {
            var that = this;

            that.target = ko.observable(null);
            that.targetIdentifier = ko.observable(null);

            that.properties = ko.observableArray([]);
            that.property = ko.observable(null);

            that.operator = ko.observable(null);
            that.operand = ko.observable(null);

            that.ready = ready;

            that.targets = ko.computed(function() {
                return targets();
            });
            that.operators = ko.computed(function() {
                var p = that.property();
                var o = operators() || [ ];

                var returnRef;

                if (p) {
                    returnRef = utilities.getOperatorsForProperty(o, p);
                } else {
                    returnRef = [ ];
                }

                that.operator(_.first(returnRef) || null);

                return returnRef;
            });
            that.qualifiers = ko.computed(function() {
                var target = that.target();

                var returnRef;

                if (target) {
                    return _.map(target.qualifier_descriptions || [], function (description, index) {
                        var value;

                        if (_.isObject(condition) && _.isArray(condition.property.target.qualifiers)) {
                            value = condition.property.target.qualifiers[index];
                        } else {
                            value = null;
                        }

                        return new AlertTargetQualifierModel(ready, description, value);
                    });
                } else {
                    returnRef = [ ];
                }

                return returnRef;
            });
            that.propertyTree = ko.computed(function() {
                var target = that.target();

                var targetProperties;

                if (target) {
                    targetProperties = utilities.getPropertiesForTarget(properties(), that.target());
                } else {
                    targetProperties = [ ];
                }

                return utilities.getPropertyTree(targetProperties);
            });

            that.selectTarget = function(target) {
                that.target(target);

                that.properties([]);
                that.properties.push(new AlertConditionTreeModel(that, that.propertyTree(), 'Category', 0));

                that.property(null);
            };
            that.selectPropertyTree = function(tree, index) {
                if (tree.items) {
                    var next = index + 1;

                    that.properties.splice(next);
                    that.properties.push(new AlertConditionTreeModel(that, tree.items, 'Property', next));

                    that.property(null);
                    that.operand(null);
                } else {
                    that.property(tree.item);
                    that.operand(_.first(that.operator().operand_options) || null);
                }
            };
            that.selectOperator = function(opertator) {
                that.operator(opertator);
            };
            that.selectOperand = function(operand) {
                that.operand(operand);
            };

            if (_.isObject(condition)) {
                that.target(_.find(targets(), function(target) {
                    return target.target_id === condition.property.target.target_id;
                }));
                that.property(_.find(properties(), function(property) {
                    return property.property_id === condition.property.property_id;
                }));
                that.operator(_.find(operators(), function(operator) {
                    return operator.operator_id === condition.operator.operator_id;
                }));

                that.targetIdentifier(condition.property.target.identifier);
                that.operand(condition.operator.operand);

                var getNode = function(items, description) {
                    return _.find(items, function(item) {
                        return item.description === description;
                    });
                };

                var node = getNode(that.propertyTree(), condition.property.group);
                var description = condition.property.description;

                for (var i = 0; i < description.length; i++) {
                    var n = getNode(node.items, description[i]);

                    that.properties.push(new AlertConditionTreeModel(that, node.items, 'Property', i, n));

                    node = n;
                }
            } else {
                that.selectTarget(_.first(that.targets()));
            }
        }
        function AlertTargetQualifierModel(ready, description, value) {
            var that = this;
            
            that.ready = ready;

            that.qualifierDescription = ko.observable(description);
            that.qualifierValue = ko.observable(value || null);
        }
        function AlertConditionTreeModel(parent, tree, description, index, node) {
            var that = this;

            that.parent = parent;

            that.tree = ko.observable(tree);
            that.node = ko.observable(node || null);

            that.description = ko.computed(function() {
                var property = that.node();

                var returnRef;

                if (property) {
                    returnRef = property.description;
                } else {
                    returnRef = 'Select ' + description;
                }

                return returnRef;
            });

            that.selectTree = function(node) {
                that.node(node);

                that.parent.selectPropertyTree(node, index);
            };

            that.showOperator = ko.computed(function() {
                var node = that.node();
                var property = that.parent.property();
                var operator = that.parent.operator();

                return _.isObject(node) && _.isObject(node.item) && node.item === property && _.isObject(operator);
            });
            that.showOptions = ko.computed(function() {
                var operator = that.parent.operator();

                return _.isObject(operator) && _.isArray(operator.operand_options) && operator.operand_options.length > 0;
            });
        }
        function AlertPublisherModel(ready, publisher) {
            var that = this;

            that.publisherTypes = publisherTypes;
            that.publisherType = ko.observable(_.first(that.publisherTypes()));
            that.recipient = ko.observable();
            that.format = ko.observable();

            that.ready = ready;

            that.selectPublisherType = function(publisherType) {
                that.publisherType(publisherType);
            };

            if (_.isObject(publisher)) {
                that.publisherType(_.find(publisherTypes(), function(candidate) {
                    return candidate.publisher_type_id === publisher.type.publisher_type_id;
                }));

                that.recipient(publisher.recipient);
                that.format(publisher.format);
            }
        }

        $(document).ready(function() {
            alertManager.connect()
                .then(function() {
                    var pageModel = new PageModel();

                    alertManager.subscribeAlerts({ user_id: userId, alert_system: system },
                        function(changedAlert) {
                            pageModel.handleAlertChange(changedAlert);
                        },
                        function(deletedAlert) {
                            pageModel.handleAlertDelete(deletedAlert);
                        }
                    );

                    alertManager.getServerVersion()
                        .then(function(version) {
                            pageModel.version(version.semver);
                        });

                    alertManager.getTargets()
                        .then(function(t) {
                            targets(t);
                        });

                    alertManager.getProperties()
                        .then(function(p) {
                            properties(p);
                        });

                    alertManager.getOperators()
                        .then(function(o) {
                            operators(o);
                        });

                    alertManager.getPublisherTypes()
                        .then(function(pt) {
                            publisherTypes(pt);
                        });

                    ko.applyBindings(pageModel, $('body')[0]);
                });
        });
    </script>

    <script type="text/html" id="alert-header-template">
        <div class="pull-left">
            <h4 class="pull-left">Barchart Alert API</h4>

            <div class="header-action-buttons pull-right">
                <span class="text-button glyphicon glyphicon-th-list" data-bind="click: changeToGrid"></span>
                <span class="text-button glyphicon glyphicon-plus" data-bind="click: changeToCreate"></span>
            </div>
        </div>
    </script>
    <script type="text/html" id="alert-grid-template">
        <table class="table table-striped small">
            <thead>
                <th class="center col-md-1"></th>
                <th class="left col-md-3">ID</th>
                <th class="left col-md-2">Name</th>
                <th class="center col-md-2">State</th>
                <th class="center col-md-1">Conditions</th>
                <th class="center col-md-1">Publishers</th>
                <th class="center col-md-2">Last Triggered</th>
            </thead>
            <tbody data-bind="template: { name: 'alert-grid-item-template', foreach: alerts }"></tbody>
        </table>
    </script>
    <script type="text/html" id="alert-grid-item-template">
        <tr>
            <td class="center col-md-1 alert-action-buttons">
                <span class="text-button text-button-black glyphicon glyphicon-search" data-bind="click: function() { $parent.changeToView($data); }"></span>
                <span class="text-button text-button-black glyphicon glyphicon-remove" data-bind="click: function() { $parent.deleteAlert($data); }, visible: !processing()"></span>
            </td>
            <td class="left col-md-3" data-bind="text: alert().alert_id"></td>
            <td class="left col-md-2" data-bind="text: alert().name"></td>
            <td class="center col-md-2">
                <div>
                <span class="alert-state-buttons">
                    <span class="text-button text-button-black glyphicon glyphicon-play" data-bind="click: start, visible: canStart"></span>
                    <span class="text-button text-button-black glyphicon glyphicon-pause" data-bind="click: pause, visible: canPause"></span>
                    <span class="text-button text-button-black glyphicon glyphicon-refresh" data-bind="click: refresh, visible: canRefresh"></span>
                </span>
                <span data-bind="text: alert().alert_state"></span>
                </div>
            </td>
            <td class="center col-md-1" data-bind="text: alert().conditions.length"></td>
            <td class="center col-md-1" data-bind="text: alert().publishers.length"></td>
            <td class="center col-md-2" data-bind="text: lastTriggerDateDisplay"></td>
        </tr>
    </script>
    <script type="text/html" id="alert-entry-template">
        <div data-bind="with: alert">
            <div class="panel panel-info">
                <div class="panel-heading">
                    <h3 class="panel-title">General</h3>
                </div>
                <table class="alert-create table">
                    <tbody>
                        <tr>
                            <td class="col-md-1">
                                <label class="control-label col-md-1">Name</label>
                            </td>
                            <td class="col-md-5">
                                <input class="form-control" data-bind="textInput: name, enable: ready" type="text" placeholder="Alert Name">
                            </td>
                            <td class="col-md-2">
                                <label class="control-label">Automatic Reset</label>
                            </td>
                            <td class="col-md-2">
                                <input type="checkbox" data-bind="checked: automaticReset, enable: ready">
                            </td>
                        </tr>
                        <tr data-bind="visible: createDate">
                            <td class="col-md-1">
                                <label class="control-label">Created</label>
                            </td>
                            <td class="col-md-9" colspan="3" data-bind="text: createDate"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="panel panel-info">
                <div class="panel-heading">
                    <h3 class="panel-title"><span class="text-button entry-item-add-button glyphicon glyphicon-plus" data-bind="click: function() { addCondition(null); }, visible: ready"></span> Conditions</h3>
                </div>
                <table class="alert-create table">
                    <!-- ko foreach: conditions -->
                    <tbody data-bind="template: { name: 'alert-create-condition-template' }"></tbody>
                    <!-- /ko -->
                </table>
            </div>
            <div class="panel panel-info">
                <div class="panel-heading">
                    <h3 class="panel-title"><span class="text-button entry-item-add-button glyphicon glyphicon-plus" data-bind="click: function() { addPublisher(null); }, visible: ready"></span> Publishers</h3>
                </div>
                <table class="alert-create table">
                    <tbody class="table" data-bind="template: { name: 'alert-create-publisher-template', foreach: publishers }"></tbody>
                </table>
            </div>
            <button class="btn btn-primary btn-default" data-bind="click: createAlert, enable: canSave">Save</button>
            <button class="btn btn-primary btn-default" data-bind="click: clearAlert, visible: complete">New</button>
        </div>
    </script>
    <script type="text/html" id="alert-create-condition-template">
        <tr class="condition">
            <td class="col-md-1">
                <span class="text-button text-button-black glyphicon glyphicon-minus entry-item-remove-button" data-bind="click: function() { $parent.removeCondition($data); }, visible: ready"></span>
            </td>
            <td class="col-md-2">
                <div class="dropdown">
                    <button class="btn btn-default dropdown-toggle" data-bind="enable: ready" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                        <span data-bind="text: target().description"></span>
                    </button>
                    <ul class="dropdown-menu" data-bind="foreach: targets">
                        <li class="center"><a href="#" data-bind="text: description, click: function() { $parent.selectTarget($data); }"></a></li>
                    </ul>
                </div>
            </td>
            <td class="col-md-3">
                <input class="form-control" data-bind="textInput: targetIdentifier, attr: { placeholder: target().identifier_description }, enable: ready" type="text" >
            </td>
            <td class="col-md-4" colspan="2">
            </td>
        </tr>
        <!-- ko foreach: qualifiers -->
        <tr class="qualifier" data-bind="template: { name: 'alert-create-condition-qualifier-template' }"></tr>
        <!-- /ko -->
        <!-- ko foreach: properties -->
        <tr class="component" data-bind="template: { name: 'alert-create-condition-property-template' }"></tr>
        <!-- /ko -->
    </script>
    <script type="text/html" id="alert-create-condition-qualifier-template">
        <td class="col-md-1"></td>
        <td class="col-md-2"></td>
        <td class="col-md-3">
            <input class="form-control" data-bind="textInput: qualifierValue, enable: ready, attr: { placeholder: qualifierDescription }" type="text">
        </td>
        <td class="col-md-4" colspan="2">
        </td>
    </script>
    <script type="text/html" id="alert-create-condition-property-template">
        <td class="col-md-1"></td>
        <td class="col-md-2"></td>
        <td class="col-md-3">
            <div class="dropdown">
                <button class="btn btn-default dropdown-toggle" type="button" data-bind="enable: parent.ready" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                    <span data-bind="text: description"></span>
                </button>
                <ul class="dropdown-menu" data-bind="foreach: tree">
                    <li class="center"><a href="#" data-bind="text: description, click: function() { $parent.selectTree($data); }"></a></li>
                </ul>
            </div>
        </td>
        <!-- ko if: showOperator -->
        <td class="col-md-2">
            <div class="dropdown">
                <button class="btn btn-default dropdown-toggle" type="button" data-bind="enable: parent.ready" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                    <span data-bind="text: parent.operator().display.short"></span>
                </button>
                <ul class="dropdown-menu" data-bind="foreach: parent.operators">
                    <li class="center"><a href="#" data-bind="text: display.short, click: function() { $parent.parent.selectOperator($data); }"></a></li>
                </ul>
            </div>
        </td>
        <!-- ko if: showOptions -->
        <td class="col-md-2">
            <div class="dropdown">
                <button class="btn btn-default dropdown-toggle" type="button" data-bind="enable: parent.ready" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                    <span data-bind="text: parent.operand()"></span>
                </button>
                <ul class="dropdown-menu" data-bind="foreach: parent.operator().operand_options">
                    <li class="center"><a href="#" data-bind="text: $data, click: function() { $parent.parent.selectOperand($data); }"></a></li>
                </ul>
            </div>
        </td>
        <!-- /ko -->
        <!-- ko ifnot: showOptions -->
        <td class="col-md-2">
            <input class="form-control" data-bind="textInput: parent.operand, enable: parent.ready" type="text" placeholder="value">
        </td>
        <!-- /ko -->
        <!-- /ko -->
        <!-- ko ifnot: showOperator -->
        <td class="col-md-4" colspan="2">
        </td>
        <!-- /ko -->
    </script>
    <script type="text/html" id="alert-create-publisher-template">
        <tr>
            <td class="col-md-1">
                <span class="text-button text-button-black glyphicon glyphicon-minus entry-item-remove-button" data-bind="click: function() { $parent.removePublisher($data); }, visible: ready"></span>
            </td>
            <td class="col-md-2">
                <div class="dropdown">
                    <button class="btn btn-default dropdown-toggle" data-bind="enable: ready" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                        <span data-bind="text: publisherType().transport"></span>
                    </button>
                    <ul class="dropdown-menu" data-bind="foreach: publisherTypes">
                        <li class="center"><a href="#" data-bind="text: transport, click: function() { $parent.selectPublisherType($data); }"></a></li>
                    </ul>
                </div>
            </td>
            <td class="col-md-3">
                <input class="form-control" data-bind="textInput: recipient, enable: ready" type="text" placeholder="Recipient (e.g. phone number)" >
            </td>
            <td class="col-md-4">
                <input class="form-control" data-bind="textInput: format, enable: ready" type="text" placeholder="Message (to include with alert)" >
            </td>
        </tr>
    </script>
</head>
<body>
    <div class="header" data-bind="template: { name: 'alert-header-template' }"></div>
    <div class="main" data-bind="template: { name: activeTemplate }"></div>
    <div class="footer">
        <h4 class="pull-left" data-bind="text: providerDescription"></h4>
        <h4 class="pull-right">API Version <span data-bind="text: version"></span></h4>
    </div>
</body>
</html>